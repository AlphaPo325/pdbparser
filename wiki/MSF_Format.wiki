#summary File layout and format description of Multi-Stream Files (MSF; enclosing format for PDB debug symbols)
#labels Phase-Implementation,Phase-Design

= Main principles =

MSF file consists of a set of streams. Each stream has the following properties:
  * ID (integer, 0-based. for example, Stream #1 always contains PDB headers)
  * Content (data pointer + length (`= NumberOfPages * MSF->PageSize`))
  * Array of page numbers
  * Number of pages

= MSF header =
MSF header (see MSF_HDR in symeng\msf.cpp) has the following layout:
  * Offset 0x00, Size 32 bytes : Signature `#define MSF_SIGNATURE_700 "Microsoft C/C++ MSF 7.00\r\n\032DS\0\0"`
  * Offset 0x20, Size DWORD : PageSize, in bytes. File size is always a multiple of page size.
  * Offset 0x24, Size DWORD : FPM Page# (Free Page Map). Destiny: unknown (field ignored).
  * Offset 0x28, Size DWORD : Page count. File size always equals `PageSize*PageCount`
  * Offset 0x2c, Size DWORD : Root directory size, in bytes.
  * Offset 0x30, Size DWORD : field reserved (not used, ignored)
  * Offset 0x34, Size array of 0x49 DWORDs : Root directory pointers (page numbers containing root directory)
Total length: 0x158 (344) bytes.

= Maximum size of MSF container =
Hardware restrictions on maximum container size are almost absent.
Maximum number of pages for root directory, as we can see, is 0x49. Root directory can hold lots of streams with big content length. Also, page size can be as big as we wish (and 32 bits can hold).
In practice, the particular implementation of PDB library can add its own restrictions on maximum page size, peak page count or maximum container length, etc..
So, MSF containers can hold lots of data.

= Root directory =
Root directory contains array of stream descriptors. Root directory is followed by free page map (complete layout is unknown, ignored).
First DWORD of root directory is the number of streams. Number of streams is followed by array of stream sizes (in pages; number of elements == stream count).
Stream size array is followed by array of stream pointers (list of page numbers of pages occupied by the stream). Number of pages in stream pointers == stream page count.
Number of streams in outer array == stream count.

= Stream types =
{{{Stream#  Description
0        Root directory (copy)
1        PDB headers (see PdbHeadersFormat)
2        TPI (type info) (see TPIFormat)
3        DBI (debug info) (see DBIHeaderFormat)
5        FPO (frame pointers omission info) (see FPOEntriesFormat)
variable GSI (global symbol information) (see GSIPSIFormat)
variable PSI (private symbol information) (see GSIPSIFormat)
}}}

= Misc =
Calculate number of pages spanned by size-length bytes: `#define STREAM_SPAN_PAGES(msf,size) (ALIGN_UP(size,msf->hdr->dwPageSize)/msf->hdr->dwPageSize)`
Other pages of the MSF contains stream data (type depends on a stream).